<!DOCTYPE html>
<html>
	<head>

		<title>bPhone</title>

		<script type="text/javascript" src="javascripts/jquery-3.1.0.min.js"></script>
		<script type="text/javascript" src="javascripts/socket.io-1.4.5.js"></script>

		<style type="text/css">

			#buy
			{
				float: left;
			}

			.newMessage
			{
				background-color: yellow;
			}

		</style>

	</head>

	<body>

		<p id="alert"></p>

		<p>Numbers:</p>

		<ul id="numbers">
			<li id="buy">Buy new number</li>
			<select id="countries"></select>
		</ul>

		<p>Messages:</p>

		<ul id="messages"></ul>

		<input id="m" autocomplete="off" />
		<input id="to" autocomplete="off" />
		<input id="from" autocomplete="off" />

		<button id="button" value="">Send</button>

	</body>

</html>

<script>

	//
	//	Connect to the socket server and create a Socket.IO object
	//
	var socket = io();

//////	  ____  _   _
//////	 / __ \| \ | |
//////	| |  | |  \| |
//////	| |  | | . ` |
//////	| |__| | |\  |
//////	 \____/|_| \_|
//////

	//
	//	Display a banner with possible various messages from the back-end
	//	The majority will be errors.
	//
	socket.on('alert', function(msg) {

		$('#alert').text(msg);

	});

	//
	//	When the app receives a new message we highlight the number that
	//	sent us the message.
	//
	socket.on('newMessage', function(obj) {

		$("#numbers").children().each(function() {

			if($(this).attr('id') == obj.to)
			{
				$(this).children().children().each(function() {

					if($(this).attr('id') == obj.from)
					{
						//
						//	Sett the yellow class to show in the UI which
						//	number got the new message.
						//
						$(this).addClass("newMessage");
					}

				});
			}

		});

	});

	//
	//	Displaying all numbers in our account.
	//
	socket.on('number', function(msg) {

		$('#numbers')
		.append(
			$('<li>')
			.attr('id', msg.nr.slice(1)) // remove the + char.
			.text(msg.nr) // Display the number
			.append(
				$('<button>')
				.text('delete')
				.attr('class', 'delete')
				.attr('value', msg.sid) // add the SID number because twill deletes numbers based on this value, and not the number it self.
				)
			.append(
				$('<ul>')
				.append(
					$('<li>')
					.append(
						$('<input>'))
					.append(
						$('<button>')
						.text('new message to')
						.attr('class', 'btnNewMessage')
						)
					)
				)
			)

	});

	//
	//	Display all the phone numbers that interacted with our numbers.
	//
	socket.on('fromNumber', function(msg) {

		$("ul li:contains('" + msg.to + "') > ul")
		.append($('<li>')
			.attr('class', 'number')
			.attr('id', msg.from.slice(1))
			.text(msg.from))

	});

	//
	//	Create an array that will be used to store all the messages
	//	for a specific conversation.
	//
	var db = [];

	//
	//	The server sends to the front-end one message at the time. Each time
	//	this happens we react to it.
	//
	socket.on('message', function(msg) {

		//
		//	Only update the messages view if it is active. Meaning someone
		//	clicked on a number and the conversation is being displayed.
		//
		if($('#messages > li').length > 0 || msg.origin == 'click')
		{
			//
			//	Add the message on the page as it comes no mater the order/
			//
			$('#messages').append($('<li>').text(msg.date + ": " + msg.body));

			//
			//	Push the message that we got a array, which will be used for
			//	storing all the messages.
			//
			db.push(msg)

			//
			//	Sort the array based on the date
			//
			db.sort(function(a, b) {

				if (a.date > b.date)
				{
					return 1;
				}

				if (a.date < b.date)
				{
					return -1;
				}

				//
				//	a must be equal to b
				//
				return 0;

			});

			//
			//	Once the array is sorted, we go over the LI list, and replace the
			//	content of the LI with the new ordered messages.
			//
			//	With this solution we can reorder the messages as they come. No
			//	matter how the server sends them to us.
			//
			$('#messages > li').each(function(index) {

				$(this).text(db[index].date+ ": " +db[index].body);

			});
		}

	});

	//
	//	After buying a number we update the interface with that bought number
	//
	socket.on('bought', function(msg) {

		$('#numbers')
		.append(
			$('<li>')
			.text(msg.nr)
			.append(
				$('<button>')
				.text('delete')
				.attr('class', 'delete')
				.attr('value', msg.sid)
				)
			.append(
				$('<ul>')
				.append(
					$('<li>')
					.append(
						$('<input>'))
					.append(
						$('<button>')
						.text('new message to')
						)
					)
				)
			)

	});

//////	  _____ _      _____ _____ _  __
//////	 / ____| |    |_   _/ ____| |/ /
//////	| |    | |      | || |    | ' /
//////	| |    | |      | || |    |  <
//////	| |____| |____ _| || |____| . \
//////	 \_____|______|_____\_____|_|\_\

	//
	//	Send a text message to the selected number
	//
	$('#button').on("click", function() {

		var to = $('#to').val();
		var from = $('#from').val();
		var message = $('#m').val();

		var obj = {
			to: to,
			from: from,
			message: message
		};

		socket.emit('sendMessage', obj);

		$('#m').val('');

	});

	//
	//	React when we want to start a new conversation with a new number
	//	that we never spoke to.
	//
	$('#numbers').on("click", ".btnNewMessage", function() {

		var nr = $(this).prev().val()

		$(this)
		.parent()
		.parent()
		.append(
			$('<li>')
			.text(nr)
			.attr('class', 'number')
			)

	});

	//
	//	Delete the selected number
	//
	$('#numbers').on("click", '.delete', function() {

		var nrElement = $(this);
		var sid = $(this).attr('value');

		socket.emit('delete', sid, function() {

			nrElement.parent().remove();

		});

	});

	//
	//	When we click on a number, we are going to ask Twilio for the whole
	//	conversation for that number.
	//
	$('#numbers').on("click", '.number', function() {

		$(this).removeClass("newMessage");

		db = [];

		var to = $(this).text();
		var from = $(this).parent()
						  .parent()
						  .clone()    	//clone the element
						  .children() 	//select all the children
						  .remove()   	//remove all the children
						  .end()  		//again go back to selected element
						  .text()

		$('#to').val(to);
		$('#from').val(from);
		$('#messages').empty();

		var obj = {
			to: to,
			from: from
		}

		//
		//	Ask the back-end for all the messages.
		//
		socket.emit('messages', obj);

	});

	//
	//	React to buy click button
	//
	$('#buy').on("click", function() {

		//
		//	Get selected country
		//
		var country = $("#countries").val();

		//
		//	Ask the back-end to buy a new number from the selected country
		//
		socket.emit('buy', country);

	});

//////	 _    _ ______ _      _____  ______ _____   _____
//////	| |  | |  ____| |    |  __ \|  ____|  __ \ / ____|
//////	| |__| | |__  | |    | |__) | |__  | |__) | (___
//////	|  __  |  __| | |    |  ___/|  __| |  _  / \___ \
//////	| |  | | |____| |____| |    | |____| | \ \ ____) |
//////	|_|  |_|______|______|_|    |______|_|  \_\_____/
//////

	//
	//	DB of countries
	//
	var countries = {
		AF: "Afghanistan",
		AX: "Åland Islands",
		AL: "Albania",
		DZ: "Algeria",
		AS: "American Samoa",
		AD: "Andorra",
		AO: "Angola",
		AI: "Anguilla",
		AQ: "Antarctica",
		AG: "Antigua and Barbuda",
		AR: "Argentina",
		AM: "Armenia",
		AW: "Aruba",
		AU: "Australia",
		AT: "Austria",
		AZ: "Azerbaijan",
		BS: "Bahamas",
		BH: "Bahrain",
		BD: "Bangladesh",
		BB: "Barbados",
		BY: "Belarus",
		BE: "Belgium",
		BZ: "Belize",
		BJ: "Benin",
		BM: "Bermuda",
		BT: "Bhutan",
		BO: "Bolivia, Plurinational State of",
		BQ: "Bonaire, Sint Eustatius and Saba",
		BA: "Bosnia and Herzegovina",
		BW: "Botswana",
		BV: "Bouvet Island",
		BR: "Brazil",
		IO: "British Indian Ocean Territory",
		BN: "Brunei Darussalam",
		BG: "Bulgaria",
		BF: "Burkina Faso",
		BI: "Burundi",
		KH: "Cambodia",
		CM: "Cameroon",
		CA: "Canada",
		CV: "Cape Verde",
		KY: "Cayman Islands",
		CF: "Central African Republic",
		TD: "Chad",
		CL: "Chile",
		CN: "China",
		CX: "Christmas Island",
		CC: "Cocos (Keeling) Islands",
		CO: "Colombia",
		KM: "Comoros",
		CG: "Congo",
		CD: "Congo, the Democratic Republic of the",
		CK: "Cook Islands",
		CR: "Costa Rica",
		CI: "Côte d'Ivoire",
		HR: "Croatia",
		CU: "Cuba",
		CW: "Curaçao",
		CY: "Cyprus",
		CZ: "Czech Republic",
		DK: "Denmark",
		DJ: "Djibouti",
		DM: "Dominica",
		DO: "Dominican Republic",
		EC: "Ecuador",
		EG: "Egypt",
		SV: "El Salvador",
		GQ: "Equatorial Guinea",
		ER: "Eritrea",
		EE: "Estonia",
		ET: "Ethiopia",
		FK: "Falkland Islands (Malvinas)",
		FO: "Faroe Islands",
		FJ: "Fiji",
		FI: "Finland",
		FR: "France",
		GF: "French Guiana",
		PF: "French Polynesia",
		TF: "French Southern Territories",
		GA: "Gabon",
		GM: "Gambia",
		GE: "Georgia",
		DE: "Germany",
		GH: "Ghana",
		GI: "Gibraltar",
		GR: "Greece",
		GL: "Greenland",
		GD: "Grenada",
		GP: "Guadeloupe",
		GU: "Guam",
		GT: "Guatemala",
		GG: "Guernsey",
		GN: "Guinea",
		GW: "Guinea-Bissau",
		GY: "Guyana",
		HT: "Haiti",
		HM: "Heard Island and McDonald Mcdonald Islands",
		VA: "Holy See (Vatican City State)",
		HN: "Honduras",
		HK: "Hong Kong",
		HU: "Hungary",
		IS: "Iceland",
		IN: "India",
		ID: "Indonesia",
		IR: "Iran, Islamic Republic of",
		IQ: "Iraq",
		IE: "Ireland",
		IM: "Isle of Man",
		IL: "Israel",
		IT: "Italy",
		JM: "Jamaica",
		JP: "Japan",
		JE: "Jersey",
		JO: "Jordan",
		KZ: "Kazakhstan",
		KE: "Kenya",
		KI: "Kiribati",
		KP: "Korea, Democratic People's Republic of",
		KR: "Korea, Republic of",
		KW: "Kuwait",
		KG: "Kyrgyzstan",
		LA: "Lao People's Democratic Republic",
		LV: "Latvia",
		LB: "Lebanon",
		LS: "Lesotho",
		LR: "Liberia",
		LY: "Libya",
		LI: "Liechtenstein",
		LT: "Lithuania",
		LU: "Luxembourg",
		MO: "Macao",
		MK: "Macedonia, the Former Yugoslav Republic of",
		MG: "Madagascar",
		MW: "Malawi",
		MY: "Malaysia",
		MV: "Maldives",
		ML: "Mali",
		MT: "Malta",
		MH: "Marshall Islands",
		MQ: "Martinique",
		MR: "Mauritania",
		MU: "Mauritius",
		YT: "Mayotte",
		MX: "Mexico",
		FM: "Micronesia, Federated States of",
		MD: "Moldova, Republic of",
		MC: "Monaco",
		MN: "Mongolia",
		ME: "Montenegro",
		MS: "Montserrat",
		MA: "Morocco",
		MZ: "Mozambique",
		MM: "Myanmar",
		NA: "Namibia",
		NR: "Nauru",
		NP: "Nepal",
		NL: "Netherlands",
		NC: "New Caledonia",
		NZ: "New Zealand",
		NI: "Nicaragua",
		NE: "Niger",
		NG: "Nigeria",
		NU: "Niue",
		NF: "Norfolk Island",
		MP: "Northern Mariana Islands",
		NO: "Norway",
		OM: "Oman",
		PK: "Pakistan",
		PW: "Palau",
		PS: "Palestine, State of",
		PA: "Panama",
		PG: "Papua New Guinea",
		PY: "Paraguay",
		PE: "Peru",
		PH: "Philippines",
		PN: "Pitcairn",
		PL: "Poland",
		PT: "Portugal",
		PR: "Puerto Rico",
		QA: "Qatar",
		RE: "Réunion",
		RO: "Romania",
		RU: "Russian Federation",
		RW: "Rwanda",
		BL: "Saint Barthélemy",
		SH: "Saint Helena, Ascension and Tristan da Cunha",
		KN: "Saint Kitts and Nevis",
		LC: "Saint Lucia",
		MF: "Saint Martin (French part)",
		PM: "Saint Pierre and Miquelon",
		VC: "Saint Vincent and the Grenadines",
		WS: "Samoa",
		SM: "San Marino",
		ST: "Sao Tome and Principe",
		SA: "Saudi Arabia",
		SN: "Senegal",
		RS: "Serbia",
		SC: "Seychelles",
		SL: "Sierra Leone",
		SG: "Singapore",
		SX: "Sint Maarten (Dutch part)",
		SK: "Slovakia",
		SI: "Slovenia",
		SB: "Solomon Islands",
		SO: "Somalia",
		ZA: "South Africa",
		GS: "South Georgia and the South Sandwich Islands",
		SS: "South Sudan",
		ES: "Spain",
		LK: "Sri Lanka",
		SD: "Sudan",
		SR: "Suriname",
		SJ: "Svalbard and Jan Mayen",
		SZ: "Swaziland",
		SE: "Sweden",
		CH: "Switzerland",
		SY: "Syrian Arab Republic",
		TW: "Taiwan, Province of China",
		TJ: "Tajikistan",
		TZ: "Tanzania, United Republic of",
		TH: "Thailand",
		TL: "Timor-Leste",
		TG: "Togo",
		TK: "Tokelau",
		TO: "Tonga",
		TT: "Trinidad and Tobago",
		TN: "Tunisia",
		TR: "Turkey",
		TM: "Turkmenistan",
		TC: "Turks and Caicos Islands",
		TV: "Tuvalu",
		UG: "Uganda",
		UA: "Ukraine",
		AE: "United Arab Emirates",
		GB: "United Kingdom",
		US: "United States",
		UM: "United States Minor Outlying Islands",
		UY: "Uruguay",
		UZ: "Uzbekistan",
		VU: "Vanuatu",
		VE: "Venezuela, Bolivarian Republic of",
		VN: "Viet Nam",
		VG: "Virgin Islands, British",
		VI: "Virgin Islands, U.S.",
		WF: "Wallis and Futuna",
		EH: "Western Sahara",
		YE: "Yemen",
		ZM: "Zambia",
		ZW: "Zimbabwe"
	};

	//
	//	Populate the drop down with all the countries
	//
	for(var key in countries)
	{
		$('#countries')
		.append($('<option>')
			.attr("value", key)
			.text(countries[key]))
	}

</script>